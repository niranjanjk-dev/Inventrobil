{% extends "base.html" %}

{% block title %}Inventory - InventroBil{% endblock %}

{% block content %}
<div>
    {% if show_alert %}
    <div class="alert alert-{{ alert_variant }} alert-dismissible fade show position-fixed bottom-0 end-0 m-3" role="alert" style="z-index: 1050;">
        {{ alert_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- {% if not can_edit %}
    <div class="alert alert-light">
        You are in view only mode. Contact a Manager or Owner to edit inventory.
    </div>
    {% endif %} -->

    <div class="alert alert-light">
        <h1 class=" fw-bold">Inventory Management</h1>
        <div class="d-flex gap-2">
            {% if can_edit %}
            <button class="btn btn-primary rounded" onclick="toggleAddForm()">Add Product</button>
            <button class="btn btn-secondary rounded" onclick="exportInventory()">Export</button>
            <button class="btn btn-secondary rounded" onclick="document.getElementById('importFile').click()">Import</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importInventory(event)">
            {% else %}
            <button class="btn btn-secondary rounded" onclick="exportInventory()">Export JSON</button>
            {% endif %}
        </div>
    </div>



    <div class="input-group mb-4">
        <span class="input-group-text">üîç</span>
        <input type="text" class="form-control" placeholder="Search by name or sku..." id="searchInventory" onkeyup="filterInventory()">
        <span class="input-group-text"><span id="filteredCount">{{ products|length }}</span>/<span id="totalCount">{{ products|length }}</span></span>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>SKU</th>
                    <th>Stock</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="inventoryTableBody">
                {% for product in products %}
                <tr data-product-id="{{ product.id }}">
                    <td class="fw-medium text-nowrap">{{ product.name }}</td>
                    <td class="text-nowrap">{{ product.category }}</td>
                    <td class="text-nowrap"><code>{{ product.sku }}</code></td>
                    <td class="text-nowrap">{{ product.stock }}</td>
                    <td class="fw-medium text-nowrap">${{ "%.2f"|format(product.price) }}</td>
                    <td class="text-nowrap">
                        {% if product.stock < 10 %}
                        <span class="badge bg-danger">Low</span>
                        {% elif product.stock < 20 %}
                        <span class="badge bg-warning text-dark">Medium</span>
                        {% else %}
                        <span class="badge bg-success">In Stock</span>
                        {% endif %}
                    </td>
                    <td class="text-nowrap">
                        {% if can_edit %}
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editProduct({{ product.id }})">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct({{ product.id }}, '{{ product.sku }}')">Delete</button>
                        {% else %}
                        <span class="text-muted" style="font-size: 12px;">View Only</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-3">No products found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Product Modal (Add/Edit) -->
<div class="modal" id="productModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">Add New Product</h5>
                <button type="button" class="btn-close" onclick="closeProductModal()"></button>
            </div>
            <form onsubmit="handleProductSubmit(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Product Name</label>
                        <input type="text" class="form-control" id="productName" placeholder="Product Name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-control" id="productSku" placeholder="SKU" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="productCategory" required>
                            <option>Plumbing</option>
                            <option>Electronics</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stock</label>
                        <input type="number" class="form-control" id="productStock" placeholder="Stock" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Price ($)</label>
                        <input type="number" class="form-control" id="productPrice" placeholder="Price" step="0.01" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                    <button class="btn btn-primary" type="submit" id="productSubmitBtn">Save Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .modal.show {
        display: block;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal {
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .modal-dialog {
        position: relative;
        width: 90%;
        max-width: 500px;
        margin: auto;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-dialog-centered {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
</style>


{% endblock %}

{% block extra_js %}
<script>
    let allProducts = {{ products|tojson }};
    let editingProductId = null;
    let isEditMode = false;

    function toggleAddForm() {
        isEditMode = false;
        editingProductId = null;
        document.getElementById('productModalTitle').textContent = 'Add New Product';
        document.getElementById('productSubmitBtn').textContent = 'Save Product';
        // Clear the form
        document.getElementById('productName').value = '';
        document.getElementById('productSku').value = '';
        document.getElementById('productCategory').value = 'Plumbing';
        document.getElementById('productStock').value = '';
        document.getElementById('productPrice').value = '';
        openProductModal();
    }

    function openProductModal() {
        document.getElementById('productModal').style.display = 'block';
        document.getElementById('productModal').classList.add('show');
    }

    function closeProductModal() {
        document.getElementById('productModal').style.display = 'none';
        document.getElementById('productModal').classList.remove('show');
        isEditMode = false;
        editingProductId = null;
    }

    function filterInventory() {
        const search = document.getElementById('searchInventory').value.toLowerCase();
        const rows = document.querySelectorAll('#inventoryTableBody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const name = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
            const sku = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
            const match = name.includes(search) || sku.includes(search);
            row.style.display = match ? '' : 'none';
            if (match) visibleCount++;
        });
        
        document.getElementById('filteredCount').textContent = visibleCount;
    }

    function editProduct(id) {
        isEditMode = true;
        editingProductId = id;
        const product = allProducts.find(p => p.id === id);
        if (product) {
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('productSubmitBtn').textContent = 'Update Product';
            document.getElementById('productName').value = product.name;
            document.getElementById('productSku').value = product.sku;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productPrice').value = product.price;
            openProductModal();
        }
    }

    function deleteProduct(id, sku) {
        if (confirm(`Are you sure you want to delete "${sku}"?`)) {
            fetch(`/api/product/${id}`, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Error deleting product');
                        });
                    }
                    return response.json();
                })
                .then(() => location.reload())
                .catch(err => {
                    alert('Error deleting product: ' + err.message);
                    console.error('Delete product error:', err);
                });
        }
    }

    function handleProductSubmit(e) {
        e.preventDefault();
        const product = {
            name: document.getElementById('productName').value,
            sku: document.getElementById('productSku').value,
            category: document.getElementById('productCategory').value,
            stock: parseInt(document.getElementById('productStock').value),
            price: parseFloat(document.getElementById('productPrice').value)
        };
        
        const method = isEditMode ? 'PUT' : 'POST';
        const url = isEditMode ? `/api/product/${editingProductId}` : '/api/product';
        const errorMsg = isEditMode ? 'Error updating product' : 'Error adding product';
        
        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(product)
        }).then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || errorMsg);
                });
            }
            return response.json();
        })
        .then(() => {
            closeProductModal();
            location.reload();
        })
        .catch(err => {
            alert(err.message);
            console.error('Product operation error:', err);
        });
    }

    function exportInventory() {
        fetch('/api/export')
            .then(r => r.json())
            .then(data => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `inventory_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            });
    }

    function importInventory(e) {
        const file = e.target.files?.[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                fetch('/api/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(() => location.reload())
                  .catch(err => alert('Error importing inventory'));
            } catch {
                alert('Error: Invalid JSON file');
            }
        };
        reader.readAsText(file);
    }

    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('productModal');
        if (event.target === modal) {
            closeProductModal();
        }
    });
</script>
{% endblock %}
