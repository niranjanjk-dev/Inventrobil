{% extends "base.html" %}

{% block title %}Billing - InventroBil{% endblock %}

{% block content %}
<div class="py-4">
    {% if show_alert %}
    <div class="alert alert-{{ alert_variant }} alert-dismissible fade show" role="alert">
        {{ alert_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Header Section -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h1 class="h2 fw-bold mb-1">Billing</h1>
                <p class="text-muted mb-0">
                    <i class="bi bi-clock-history"></i>
                    <strong>{{ billing_history|length }}</strong> transactions today | cashier: <strong>{{ user.username }}</strong>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row g-4">
        <!-- Products Section -->
        <div class="col-lg-5">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-header bg-dark text-white border-0 py-3">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-box"></i> Products
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="p-3 border-bottom">
                        <div class="input-group">
                            <span class="input-group-text">üîç</span>
                            <input type="text" class="form-control" placeholder="Search by name or sku..." id="searchBilling" onkeyup="filterBillingProducts()">
                            <span class="input-group-text"><span id="filteredCount">{{ products|length }}</span>/<span id="totalCount">{{ products|length }}</span></span>
                        </div>
                    </div>

                    <div id="productsList">
                        {% for product in products %}
                            {% if product.stock > 0 %}
                            <div class="list-group-item border-0 border-bottom d-flex justify-content-between align-items-center p-3" data-product-id="{{ product.id }}">
                                <div class="flex-grow-1">
                                    <div class="fw-bold">{{ product.name }}</div>
                                    <small class="text-muted d-block">{{ product.category }}</small>
                                    <div class="mt-2">
                                        <span class="badge bg-success">
                                            <i class="bi bi-tag"></i> ${{ "%.2f"|format(product.price) }}
                                        </span>
                                        <span class="badge bg-light text-dark ms-2">
                                            <i class="bi bi-box"></i> {{ product.stock }}
                                        </span>
                                        <span class="badge bg-primary ms-2" id="cartBadge{{ product.id }}" style="display: none;">
                                            <span id="cartCount{{ product.id }}"></span>
                                        </span>
                                    </div>
                                </div>
                                <button class="btn btn-success btn-sm ms-2" onclick="addToCart({{ product.id }}, '{{ product.name }}', {{ product.price }}, {{ product.stock }})">
                                    <i class="bi bi-plus-circle"></i> Add
                                </button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Bill Section -->
        <div class="col-lg-7">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-white border-0 py-3">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-receipt"></i> Current Bill
                    </h5>
                </div>
                <div class="card-body">
                    <div id="cartEmpty" class="text-center py-5">
                        <i class="bi bi-cart-x text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3 mb-0">No items in cart</p>
                        <p class="text-muted small">Add products to get started</p>
                    </div>

                    <div id="cartContent" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-sm mb-3">
                                <thead class="table-light border-bottom">
                                    <tr>
                                        <th>Item</th>
                                        <th class="text-center">Qty</th>
                                        <th class="text-center">Price</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="cartItems">
                                </tbody>
                            </table>
                        </div>

                        <!-- Totals Section -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Subtotal:</span>
                                <strong id="subtotal" class="h6 mb-0">$0.00</strong>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">
                                    Discount:
                                    <div class="input-group d-inline-flex ms-2" style="width: 80px;">
                                        <input type="number" class="form-control form-control-sm text-center" id="discountPercent" value="0" onchange="updateBillTotals()" step="1" min="0" max="100">
                                        <span class="input-group-text input-group-text-sm">%</span>
                                    </div>
                                </span>
                                <strong id="discountAmount" class="h6 mb-0 text-danger">-$0.00</strong>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">GST (18%):</span>
                                <strong id="gstAmount" class="h6 mb-0">$0.00</strong>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="fw-bold">Grand Total:</span>
                                <strong class="text-success fw-bold mb-0" id="totalAmount">$0.00</strong>
                            </div>
                            <hr>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <button class="btn btn-outline-danger w-25" onclick="clearCart()">
                                <i class="bi bi-trash"></i> Clear Cart
                            </button>
                            <button class="btn btn-success fw-bold w-75" onclick="checkout()">
                                <i class="bi bi-check-circle"></i> Checkout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let cart = [];
    const GST_RATE = 18;
    const products = {{ products|tojson }};

    function addToCart(id, name, price, stock) {
        const existing = cart.find(item => item.id === id);
        if (existing) {
            if (existing.quantity < stock) {
                existing.quantity++;
            } else {
                alert(`Cannot add more items. Only ${stock} in stock.`);
                return;
            }
        } else {
            cart.push({ id, name, price, quantity: 1, stock });
        }
        updateCartUI();
    }

    function removeFromCart(id) {
        cart = cart.filter(item => item.id !== id);
        updateCartUI();
    }

    function updateQuantity(id, quantity) {
        const item = cart.find(item => item.id === id);
        if (!item) return;
        
        if (quantity <= 0) {
            removeFromCart(id);
        } else if (quantity > item.stock) {
            alert(`Cannot exceed stock. Only ${item.stock} available.`);
        } else {
            item.quantity = quantity;
            updateCartUI();
        }
    }

    function updateCartUI() {
        if (cart.length === 0) {
            document.getElementById('cartEmpty').style.display = 'block';
            document.getElementById('cartContent').style.display = 'none';
            return;
        }

        document.getElementById('cartEmpty').style.display = 'none';
        document.getElementById('cartContent').style.display = 'block';

        const cartItemsHtml = cart.map(item => `
            <tr>
                <td class="small fw-bold align-middle">${item.name}</td>
                <td class="text-center">
                    <div class="input-group input-group-sm" style="width: 100px; margin: 0 auto;">
                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${item.id}, ${item.quantity - 1})" style="padding: 0.25rem 0.5rem;">‚àí</button>
                        <input type="number" class="form-control text-center" value="${item.quantity}" onchange="updateQuantity(${item.id}, this.value)">
                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${item.id}, ${item.quantity + 1})" style="padding: 0.25rem 0.5rem;">+</button>
                    </div>
                </td>
                <td class="text-center small align-middle">$${item.price.toFixed(2)}</td>
                <td class="text-center small fw-bold align-middle">$${(item.price * item.quantity).toFixed(2)}</td>
                <td class="text-center small fw-bold align-middle text-danger" style="cursor: pointer;" onclick="removeFromCart(${item.id})">remove</td>
            </tr>
        `).join('');

        document.getElementById('cartItems').innerHTML = cartItemsHtml;
        updateBillTotals();

        // Update cart badges
        products.forEach(p => {
            const badge = document.getElementById(`cartBadge${p.id}`);
            const badgeCount = document.getElementById(`cartCount${p.id}`);
            const cartItem = cart.find(item => item.id === p.id);
            if (cartItem) {
                badgeCount.textContent = `${cartItem.quantity} in cart`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        });
    }

    function updateBillTotals() {
        const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const discountPercent = parseInt(document.getElementById('discountPercent').value) || 0;
        const discountAmount = (subtotal * discountPercent) / 100;
        const subtotalAfterDiscount = subtotal - discountAmount;
        const gstAmount = (subtotalAfterDiscount * GST_RATE) / 100;
        const total = subtotalAfterDiscount + gstAmount;

        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('discountAmount').textContent = `-$${discountAmount.toFixed(2)}`;
        document.getElementById('gstAmount').textContent = `$${gstAmount.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
    }

    function filterBillingProducts() {
        const search = document.getElementById('searchBilling').value.toLowerCase();
        const items = document.querySelectorAll('#productsList .list-group-item');
        
        items.forEach(item => {
            const productId = item.getAttribute('data-product-id');
            const product = products.find(p => p.id === parseInt(productId));
            if (product) {
                const match = product.name.toLowerCase().includes(search) || product.sku.toLowerCase().includes(search);
                item.style.display = match ? '' : 'none';
            }
        });
    }

    function checkout() {
        if (cart.length === 0) {
            alert('Cart is empty');
            return;
        }

        const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const discountPercent = parseInt(document.getElementById('discountPercent').value) || 0;
        const discountAmount = (subtotal * discountPercent) / 100;
        const subtotalAfterDiscount = subtotal - discountAmount;
        const gstAmount = (subtotalAfterDiscount * GST_RATE) / 100;
        const total = subtotalAfterDiscount + gstAmount;

        const billingRecord = {
            items: cart,
            subtotal: subtotal,
            discountPercent: discountPercent,
            discountAmount: discountAmount,
            gstRate: GST_RATE,
            gstAmount: gstAmount,
            total: total
        };

        fetch('/api/billing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(billingRecord)
        }).then(() => {
            cart = [];
            document.getElementById('discountPercent').value = 0;
            updateCartUI();
            alert(`Checkout completed! Total: $${total.toFixed(2)}`);
        }).catch(err => alert('Checkout error: ' + err));
    }

    function clearCart() {
        if (cart.length > 0 && confirm('Are you sure you want to clear the cart?')) {
            cart = [];
            document.getElementById('discountPercent').value = 0;
            updateCartUI();
        }
    }
</script>
{% endblock %}
