{% extends "base.html" %}

{% block title %}Billing & POS - InventroBil Web{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if show_alert %}
    <div class="alert alert-{{ alert_variant }} alert-dismissible fade show" role="alert">
        {{ alert_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-12">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2>Billing & POS System</h2>
                    <small class="text-muted">
                        {{ billing_history|length }} transactions today
                    </small>
                </div>
                <div style="background: #f0f4ff; padding: 10px 15px; border-radius: 5px; border-left: 3px solid #667eea;">
                    <small style="color: #667eea;">Cashier: <strong>{{ user.username }}</strong></small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Products Section -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Products</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">ðŸ”Ž</span>
                        <input type="text" class="form-control" placeholder="Search products..." id="searchBilling" onkeyup="filterBillingProducts()">
                    </div>

                    <div id="productsList" style="max-height: 500px; overflow-y: auto;">
                        {% for product in products %}
                            {% if product.stock > 0 %}
                            <div class="list-group-item d-flex justify-content-between align-items-center" data-product-id="{{ product.id }}">
                                <div>
                                    <div class="fw-bold">{{ product.name }}</div>
                                    <small class="text-muted">{{ product.category }}</small>
                                    <div>
                                        <span class="badge bg-info">${{ "%.2f"|format(product.price) }}</span>
                                        <span class="badge bg-light text-dark ms-2">Stock: {{ product.stock }}</span>
                                        <span class="badge bg-success ms-2" id="cartBadge{{ product.id }}" style="display: none;"></span>
                                    </div>
                                </div>
                                <button class="btn btn-success btn-sm" onclick="addToCart({{ product.id }}, '{{ product.name }}', {{ product.price }}, {{ product.stock }})">Add</button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Bill Section -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Current Bill</h5>
                </div>
                <div class="card-body">
                    <div id="cartEmpty" class="text-center py-5 text-muted">
                        <p>No items in cart</p>
                        <p>Add products to get started</p>
                    </div>

                    <div id="cartContent" style="display: none;">
                        <table class="table table-hover mb-3">
                            <thead class="table-light">
                                <tr>
                                    <th>Item</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cartItems">
                            </tbody>
                        </table>

                        <hr>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <strong id="subtotal">$0.00</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>
                                    Discount:
                                    <div class="input-group d-inline-flex ms-2" style="width: 100px;">
                                        <input type="number" class="form-control" id="discountPercent" value="0" onchange="updateBillTotals()" step="1">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </span>
                                <strong id="discountAmount">-$0.00</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>GST (18%):</span>
                                <strong id="gstAmount">$0.00</strong>
                            </div>
                        </div>

                        <div class="card bg-light">
                            <div class="card-body text-center py-3">
                                <h5 class="mb-2">Grand Total</h5>
                                <h2 class="text-success fw-bold" id="totalAmount">$0.00</h2>
                            </div>
                        </div>

                        <div class="mt-3 d-grid gap-2">
                            <button class="btn btn-success btn-lg mb-2" onclick="checkout()">Checkout</button>
                            <button class="btn btn-outline-danger" onclick="clearCart()">Clear Cart</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let cart = [];
    const GST_RATE = 18;
    const products = {{ products|tojson }};

    function addToCart(id, name, price, stock) {
        const existing = cart.find(item => item.id === id);
        if (existing) {
            if (existing.quantity < stock) {
                existing.quantity++;
            } else {
                alert(`Cannot add more items. Only ${stock} in stock.`);
                return;
            }
        } else {
            cart.push({ id, name, price, quantity: 1, stock });
        }
        updateCartUI();
    }

    function removeFromCart(id) {
        cart = cart.filter(item => item.id !== id);
        updateCartUI();
    }

    function updateQuantity(id, quantity) {
        const item = cart.find(item => item.id === id);
        if (!item) return;
        
        if (quantity <= 0) {
            removeFromCart(id);
        } else if (quantity > item.stock) {
            alert(`Cannot exceed stock. Only ${item.stock} available.`);
        } else {
            item.quantity = quantity;
            updateCartUI();
        }
    }

    function updateCartUI() {
        if (cart.length === 0) {
            document.getElementById('cartEmpty').style.display = 'block';
            document.getElementById('cartContent').style.display = 'none';
            return;
        }

        document.getElementById('cartEmpty').style.display = 'none';
        document.getElementById('cartContent').style.display = 'block';

        const cartItemsHtml = cart.map(item => `
            <tr>
                <td class="fw-bold">${item.name}</td>
                <td>
                    <div class="input-group" style="width: 70px;">
                        <button class="btn btn-outline-danger btn-sm" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">âˆ’</button>
                        <input type="number" class="form-control text-center" value="${item.quantity}" onchange="updateQuantity(${item.id}, this.value)">
                        <button class="btn btn-outline-success btn-sm" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                    </div>
                </td>
                <td>$${item.price.toFixed(2)}</td>
                <td class="fw-bold">$${(item.price * item.quantity).toFixed(2)}</td>
                <td>
                    <button class="btn btn-outline-danger btn-sm" onclick="removeFromCart(${item.id})">remove</button>
                </td>
            </tr>
        `).join('');

        document.getElementById('cartItems').innerHTML = cartItemsHtml;
        updateBillTotals();

        // Update cart badges
        products.forEach(p => {
            const badge = document.getElementById(`cartBadge${p.id}`);
            const cartItem = cart.find(item => item.id === p.id);
            if (cartItem) {
                badge.textContent = `In Cart: ${cartItem.quantity}`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        });
    }

    function updateBillTotals() {
        const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const discountPercent = parseInt(document.getElementById('discountPercent').value) || 0;
        const discountAmount = (subtotal * discountPercent) / 100;
        const subtotalAfterDiscount = subtotal - discountAmount;
        const gstAmount = (subtotalAfterDiscount * GST_RATE) / 100;
        const total = subtotalAfterDiscount + gstAmount;

        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('discountAmount').textContent = `-$${discountAmount.toFixed(2)}`;
        document.getElementById('gstAmount').textContent = `$${gstAmount.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
    }

    function filterBillingProducts() {
        const search = document.getElementById('searchBilling').value.toLowerCase();
        const items = document.querySelectorAll('#productsList .list-group-item');
        
        items.forEach(item => {
            const productId = item.getAttribute('data-product-id');
            const product = products.find(p => p.id === parseInt(productId));
            if (product) {
                const match = product.name.toLowerCase().includes(search) || product.sku.toLowerCase().includes(search);
                item.style.display = match ? '' : 'none';
            }
        });
    }

    function checkout() {
        if (cart.length === 0) {
            alert('Cart is empty');
            return;
        }

        const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const discountPercent = parseInt(document.getElementById('discountPercent').value) || 0;
        const discountAmount = (subtotal * discountPercent) / 100;
        const subtotalAfterDiscount = subtotal - discountAmount;
        const gstAmount = (subtotalAfterDiscount * GST_RATE) / 100;
        const total = subtotalAfterDiscount + gstAmount;

        const billingRecord = {
            items: cart,
            subtotal: subtotal,
            discountPercent: discountPercent,
            discountAmount: discountAmount,
            gstRate: GST_RATE,
            gstAmount: gstAmount,
            total: total
        };

        fetch('/api/billing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(billingRecord)
        }).then(() => {
            cart = [];
            document.getElementById('discountPercent').value = 0;
            updateCartUI();
            alert(`Checkout completed! Total: $${total.toFixed(2)}`);
        }).catch(err => alert('Checkout error: ' + err));
    }

    function clearCart() {
        if (cart.length > 0 && confirm('Are you sure you want to clear the cart?')) {
            cart = [];
            document.getElementById('discountPercent').value = 0;
            updateCartUI();
        }
    }
</script>
{% endblock %}
